<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Control - Propietario</title>
    <link rel="stylesheet" href="vistas/tablero_control_propietario.css">
</head>
<body>
    <div class="tablero-container">
        <!-- Sección de Notificaciones -->
        <section class="seccion" id="notificaciones">
            <div class="notificaciones-header">
                <h2>Notificaciones</h2>
                <button class="btn-borrar" onclick="borrarNotificaciones()">
                    Borrar todas
                </button>
            </div>
            <ul class="lista-notificaciones" id="lista-notificaciones">
                <!-- Las notificaciones se agregarán dinámicamente -->
            </ul>
        </section>

        <!-- Grid de 2 columnas para datos del propietario y vehículos -->
        <div class="grid-50-50">
            <section class="seccion" id="datos-propietario">
                <h2>Datos del Propietario</h2>
                <div id="info-propietario">
                    <!-- Los datos del propietario se cargarán dinámicamente -->
                </div>
            </section>

            <section class="seccion" id="vehiculos">
                <h2>Mis Vehículos</h2>
                <div id="lista-vehiculos">
                    <!-- La tabla de vehículos se generará dinámicamente -->
                </div>
            </section>
        </div>

        <!-- Sección de Tránsitos Recientes -->
        <section class="seccion" id="transitos">
            <h2>Tránsitos Recientes</h2>
            <div id="lista-transitos">
                <!-- La tabla de tránsitos se generará dinámicamente -->
            </div>
        </section>

        <!-- Sección de Bonificaciones -->
        <section class="seccion" id="bonificaciones">
            <h2>Bonificaciones</h2>
            <div id="lista-bonificaciones">
                <!-- La tabla de bonificaciones se generará dinámicamente -->
            </div>
        </section>
    </div>

    <script>
    // Endpoint real que requiere sesión
    var urlIniciarVista = '/tablero/informacion';
        var parametrosInicioVista = '';
        var prefijoNombreFuncionProcesoResultado = 'mostrar_';
    </script>
    <script src="utilesVista.js"></script>
    <script src="vistaWeb.js"></script>
    <script>
        // Fallback: si urlIniciarVista sigue sin definirse en tiempo de ejecución,
        // forzamos el uso del mock. No ejecutamos submit aquí para evitar
        // envíos duplicados (vistaWeb.js hace el submit inicial en DOMContentLoaded).
        if (!window.urlIniciarVista) {
            console.warn('Fallback: urlIniciarVista no definida; usando /tablero/informacion/mock');
            window.urlIniciarVista = '/tablero/informacion/mock';
        }
    </script>
    <script>
        // Manejo simple de errores de carga
        function mostrarError(msg) {
            console.error(msg);
            alert(msg);
        }

        // Las funciones mostrar_<id> serán llamadas por vistaWeb.js al recibir la lista de Respuesta
        function mostrar_propietario(param) {
            console.log('mostrar_propietario recibido:', param);
            if (!param) return mostrarError('Propietario vacío');
            mostrarDatosPropietario(param);
        }

        // Si el servidor indica que no hay sesión activa, redirigimos al login
        function mostrar_NoSesion(param) {
            console.warn('Servidor indica que no hay sesión activa:', param);
            mostrarMensaje('No se ha iniciado sesión. Será redirigido al login.').then(() => {
                window.location.href = '/login_Propietario.html';
            }).catch(() => { window.location.href = '/login_Propietario.html'; });
        }

        function mostrar_vehiculos(param) {
            console.log('mostrar_vehiculos recibido:', param);
            if (!param) return document.getElementById('lista-vehiculos').innerHTML = '<p>No hay vehículos.</p>';
            mostrarVehiculos(param);
        }

        function mostrar_transitosRealizados(param) {
            console.log('mostrar_transitosRealizados recibido:', param);
            if (!param) return document.getElementById('lista-transitos').innerHTML = '<p>No hay tránsitos.</p>';
            mostrarTransitos(param);
        }

        function mostrar_asignaciones(param) {
            console.log('mostrar_asignaciones recibido:', param);
            if (!param) return document.getElementById('lista-bonificaciones').innerHTML = '<p>No hay asignaciones.</p>';
            mostrarBonificaciones(param);
        }

        function mostrarDatosPropietario(data) {
            const propietarioDiv = document.getElementById('info-propietario');
            if (!data) return propietarioDiv.innerHTML = '<p>Sin datos del propietario.</p>';
            const tabla = crearTabla(['Campo', 'Valor'], [
                ['Nombre', data.nombreCompleto || ''],
                ['Estado', data.estado || ''],
                ['Saldo', data.saldo !== undefined ? data.saldo : '']
            ]);
            propietarioDiv.innerHTML = '';
            propietarioDiv.appendChild(tabla);
        }

        function mostrarVehiculos(vehiculos) {
            const vehiculosDiv = document.getElementById('lista-vehiculos');
            if (!Array.isArray(vehiculos) || vehiculos.length === 0) return vehiculosDiv.innerHTML = '<p>No hay vehículos.</p>';
            const tablaHtml = crearTablaDesdeJson(vehiculos);
            vehiculosDiv.innerHTML = tablaHtml;
        }

        function mostrarTransitos(transitos) {
            const transitosDiv = document.getElementById('lista-transitos');
            if (!Array.isArray(transitos) || transitos.length === 0) return transitosDiv.innerHTML = '<p>No hay tránsitos recientes.</p>';
            // Mapear campos a una representación simple si hace falta
            const tablaHtml = crearTablaDesdeJson(transitos);
            transitosDiv.innerHTML = tablaHtml;
        }

        function mostrarBonificaciones(bonificaciones) {
            const bonificacionesDiv = document.getElementById('lista-bonificaciones');
            if (!Array.isArray(bonificaciones) || bonificaciones.length === 0) return bonificacionesDiv.innerHTML = '<p>No hay bonificaciones.</p>';
            const tablaHtml = crearTablaDesdeJson(bonificaciones);
            bonificacionesDiv.innerHTML = tablaHtml;
        }

        function borrarNotificaciones() {
            const lista = document.getElementById('lista-notificaciones');
            lista.innerHTML = '';
            // Opcional: llamar al backend para marcar como leídas usando vistaWeb.js submit si se desea
            try {
                submit('/api/propietario/notificaciones/borrar','');
            } catch (e) {
                console.error('Error al marcar notificaciones como borradas', e);
            }
        }
    </script>
</body>
</html>